<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>K8s学习笔记 | 卷心菜的学习笔记</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="01.k8s集群环境部署 环境三台 CentOS 7 服务器，网络已通  关闭防火墙，命令如下   12systemctl stop firewalldsystemctl disable firewalld   关闭SELinux  1234567sudo vim &#x2F;etc&#x2F;sysconfig&#x2F;selinux# 将SELINUX修改为disabledSELINUX&#x3D;disabled# 重启系统su">
<meta property="og:type" content="website">
<meta property="og:title" content="K8s学习笔记">
<meta property="og:url" content="https://chengfengjie718.github.io/java/k8s.html">
<meta property="og:site_name" content="卷心菜的学习笔记">
<meta property="og:description" content="01.k8s集群环境部署 环境三台 CentOS 7 服务器，网络已通  关闭防火墙，命令如下   12systemctl stop firewalldsystemctl disable firewalld   关闭SELinux  1234567sudo vim &#x2F;etc&#x2F;sysconfig&#x2F;selinux# 将SELINUX修改为disabledSELINUX&#x3D;disabled# 重启系统su">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-01-10T07:50:05.000Z">
<meta property="article:modified_time" content="2024-11-06T02:56:18.110Z">
<meta property="article:author" content="chengfengjie718">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="卷心菜的学习笔记" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">卷心菜的学习笔记</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">天行健，君子以自强不息；地势坤，君子以厚德载物。</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://chengfengjie718.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="page-" class="h-entry article article-type-page" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/java/k8s.html" class="article-date">
  <time class="dt-published" datetime="2020-01-10T07:50:05.000Z" itemprop="datePublished">2020-01-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      K8s学习笔记
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="01-k8s集群环境部署"><a href="#01-k8s集群环境部署" class="headerlink" title="01.k8s集群环境部署"></a>01.k8s集群环境部署</h1><ul>
<li><p>环境三台 <code>CentOS 7</code> 服务器，网络已通</p>
</li>
<li><p>关闭防火墙，命令如下</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭SELinux</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vim /etc/sysconfig/selinux</span><br><span class="line"><span class="comment"># 将SELINUX修改为disabled</span></span><br><span class="line">SELINUX=disabled</span><br><span class="line"><span class="comment"># 重启系统</span></span><br><span class="line"><span class="built_in">sudo</span> reboot</span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">sestatus</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭swap</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vim /etc/fstab</span><br><span class="line"><span class="comment"># 注释如下行</span></span><br><span class="line">/dev/mapper/VolGroup-lv_swap swap                    swap    defaults        0 0</span><br><span class="line"><span class="comment"># 使配置生效</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<ul>
<li>设置主机名</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在三台主机上分别设置主机名称</span></span><br><span class="line">hostnamectl set-hostname k8s-master</span><br><span class="line">hostnamectl set-hostname k8s-node2</span><br><span class="line">hostnamectl set-hostname k8s-node3</span><br></pre></td></tr></table></figure>

<ul>
<li>在master节点配置hosts</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /etc/hosts ~/</span><br><span class="line">vim hosts</span><br><span class="line"><span class="comment"># 增加内容如下,这个三个ip地址对应三台主机ip</span></span><br><span class="line">10.211.55.10 k8s-master</span><br><span class="line">10.211.55.11 k8s-node2</span><br><span class="line">10.211.55.12 k8s-node3</span><br></pre></td></tr></table></figure>

<ul>
<li>配置<code>yum</code>源，否则安装<code>docker</code>等工具会报错</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 下载阿里云yum源</span><br><span class="line">sudo curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"># 清除缓存</span><br><span class="line">sudo yum clean all</span><br><span class="line"># 重新生成yum缓存</span><br><span class="line">sudo yum makecache</span><br></pre></td></tr></table></figure>

<ul>
<li>安装<code>docker</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"><span class="built_in">sudo</span> yum -y install docker-ce</span><br><span class="line"><span class="comment"># 启动docker</span></span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure>

<ul>
<li>安装 <code>kubeadm</code> 、 <code>kubectl</code>、 <code>kubelet</code>， 安装过程中发现很多仓库都有网络问题，最后从阿里云直接手动下载安装，下载地址为: <a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.30/rpm/x86_64/">https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.30/rpm/x86_64&#x2F;</a><br>下载对应版本的 <code>cri</code> 、 <code>kubeadm</code>、 <code>kubectl</code> 、 <code>kubelet</code> 、 <code>kubernetes-cni</code>， 我在此下载的是 <code>1.30.6</code>， 下载完成之后执行如下命令安装</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum install cri-tools-1.30.1-150500.1.1.x86_64.rpm</span><br><span class="line"><span class="built_in">sudo</span> yum install kubectl-1.30.6-150500.1.1.x86_64.rpm</span><br><span class="line"><span class="built_in">sudo</span> yum install kubernetes-cni-1.4.0-150500.1.1.x86_64.rpm</span><br><span class="line"><span class="built_in">sudo</span> yum install kubeadm-1.30.6-150500.1.1.x86_64.rpm</span><br><span class="line"><span class="built_in">sudo</span> yum install kubelet-1.30.6-150500.1.1.x86_64.rpm</span><br></pre></td></tr></table></figure>

<ul>
<li>部署 <code>k8s-master</code> 服务, 流程如下</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用如下命令生成kubeadm init 的默认配置文件</span></span><br><span class="line">kubeadm config <span class="built_in">print</span> init-defaults &gt; init-config.yaml</span><br><span class="line"><span class="comment"># 修改init-config.yaml配置文件，修改内容如下</span></span><br><span class="line">vim init-config.yaml</span><br></pre></td></tr></table></figure>

<p>配置文件内容如下，具体每一项的含义可以参考文档: <a target="_blank" rel="noopener" href="https://v1-30.docs.kubernetes.io/zh-cn/docs/reference/config-api/kubeadm-config.v1beta3">https://v1-30.docs.kubernetes.io/zh-cn/docs/reference/config-api/kubeadm-config.v1beta3</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">bootstrapTokens:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">system:bootstrappers:kubeadm:default-node-token</span></span><br><span class="line">  <span class="attr">token:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line">  <span class="attr">ttl:</span> <span class="string">24h0m0s</span></span><br><span class="line">  <span class="attr">usages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">signing</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">authentication</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">10.211</span><span class="number">.55</span><span class="number">.10</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">unix:///var/run/containerd/containerd.sock</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s-master</span></span><br><span class="line">  <span class="attr">taints:</span> <span class="literal">null</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controllerManager:</span> &#123;&#125;</span><br><span class="line"><span class="attr">dns:</span> &#123;&#125;</span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="number">1.30</span><span class="number">.6</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line"><span class="attr">scheduler:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>执行命令 <code>sudo kubeadm init --config=./init-config.yaml</code>, 输出如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">[init] Using Kubernetes version: v1.30.6</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[preflight] Pulling images required <span class="keyword">for</span> setting up a Kubernetes cluster</span><br><span class="line">[preflight] This might take a minute or two, depending on the speed of your internet connection</span><br><span class="line">[preflight] You can also perform this action <span class="keyword">in</span> beforehand using <span class="string">&#x27;kubeadm config images pull&#x27;</span></span><br><span class="line">W1105 22:09:22.758409   19650 checks.go:844] detected that the sandbox image <span class="string">&quot;registry.k8s.io/pause:3.6&quot;</span> of the container runtime is inconsistent with that used by kubeadm.It is recommended to use <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9&quot;</span> as the CRI sandbox image.</span><br><span class="line">[certs] Using certificateDir folder <span class="string">&quot;/etc/kubernetes/pki&quot;</span></span><br><span class="line">[certs] Generating <span class="string">&quot;ca&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;apiserver&quot;</span> certificate and key</span><br><span class="line">[certs] apiserver serving cert is signed <span class="keyword">for</span> DNS names [k8s-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 10.211.55.10]</span><br><span class="line">[certs] Generating <span class="string">&quot;apiserver-kubelet-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;front-proxy-ca&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;front-proxy-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/ca&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/server&quot;</span> certificate and key</span><br><span class="line">[certs] etcd/server serving cert is signed <span class="keyword">for</span> DNS names [k8s-master localhost] and IPs [10.211.55.10 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/peer&quot;</span> certificate and key</span><br><span class="line">[certs] etcd/peer serving cert is signed <span class="keyword">for</span> DNS names [k8s-master localhost] and IPs [10.211.55.10 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/healthcheck-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;apiserver-etcd-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;sa&quot;</span> key and public key</span><br><span class="line">[kubeconfig] Using kubeconfig folder <span class="string">&quot;/etc/kubernetes&quot;</span></span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;admin.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;super-admin.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;kubelet.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;controller-manager.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;scheduler.conf&quot;</span> kubeconfig file</span><br><span class="line">[etcd] Creating static Pod manifest <span class="keyword">for</span> <span class="built_in">local</span> etcd <span class="keyword">in</span> <span class="string">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line">[control-plane] Using manifest folder <span class="string">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-apiserver&quot;</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-controller-manager&quot;</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-scheduler&quot;</span></span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file <span class="string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class="line">[kubelet-start] Writing kubelet configuration to file <span class="string">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[wait-control-plane] Waiting <span class="keyword">for</span> the kubelet to boot up the control plane as static Pods from directory <span class="string">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line">[kubelet-check] Waiting <span class="keyword">for</span> a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><br><span class="line">[kubelet-check] The kubelet is healthy after 1.001766963s</span><br><span class="line">[api-check] Waiting <span class="keyword">for</span> a healthy API server. This can take up to 4m0s</span><br><span class="line">[api-check] The API server is healthy after 4.501987306s</span><br><span class="line">[upload-config] Storing the configuration used <span class="keyword">in</span> ConfigMap <span class="string">&quot;kubeadm-config&quot;</span> <span class="keyword">in</span> the <span class="string">&quot;kube-system&quot;</span> Namespace</span><br><span class="line">[kubelet] Creating a ConfigMap <span class="string">&quot;kubelet-config&quot;</span> <span class="keyword">in</span> namespace kube-system with the configuration <span class="keyword">for</span> the kubelets <span class="keyword">in</span> the cluster</span><br><span class="line">[upload-certs] Skipping phase. Please see --upload-certs</span><br><span class="line">[mark-control-plane] Marking the node k8s-master as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span><br><span class="line">[mark-control-plane] Marking the node k8s-master as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]</span><br><span class="line">[bootstrap-token] Using token: abcdef.0123456789abcdef</span><br><span class="line">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class="keyword">in</span> order <span class="keyword">for</span> nodes to get long term certificate credentials</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow certificate rotation <span class="keyword">for</span> all node client certificates <span class="keyword">in</span> the cluster</span><br><span class="line">[bootstrap-token] Creating the <span class="string">&quot;cluster-info&quot;</span> ConfigMap <span class="keyword">in</span> the <span class="string">&quot;kube-public&quot;</span> namespace</span><br><span class="line">[kubelet-finalize] Updating <span class="string">&quot;/etc/kubernetes/kubelet.conf&quot;</span> to point to a rotatable kubelet client certificate and key</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> 10.211.55.10:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">	--discovery-token-ca-cert-hash sha256:0c10cc403831b3f0af6dad4a12ee6877201ad903a908b3d453879a7a730dbb97 </span><br></pre></td></tr></table></figure>

<h1 id="02-kubectl常用基本命令"><a href="#02-kubectl常用基本命令" class="headerlink" title="02.kubectl常用基本命令"></a>02.kubectl常用基本命令</h1><ul>
<li><p><code>kubectl create namespace &#123;空间名称&#125;</code> : 创建命名空间</p>
</li>
<li><p><code>kubectl apply -f ./core-eureka-pod.yaml --namespace=ipo-platform</code> : 创建Pod<br><code>--namespace=&#123;命名空间&#125;</code> : 指定命名空间<br><code>-f &#123;配置文件&#125;</code> : 指定配置文件，可以从网络加载，例如可以是<code>https://k8s.io/examples/pods/qos/qos-pod.yaml</code></p>
</li>
<li><p><code>kubectl delete -n ipo-platform pod core-eureka-pod</code> : 删除Pod<br><code>-n &#123;命名空间&#125;</code> : 指定命名空间<br><code>pod &#123;Pod名称&#125;</code> : 删除的pod</p>
</li>
<li><p><code>kubectl get deploy -n &#123;命名空间&#125;</code> : 查看命名空间内的<code>Deployment</code></p>
</li>
<li><p><code>kubectl get pods -n ipo-platform</code> : 查看命名空间内的<code>Pod</code></p>
</li>
<li><p><code>kubectl get service -n ipo-platform</code> : 查看命名空间的<code>Service</code></p>
</li>
<li><p><code>kubectl delete -n ipo-platform deployment eureka-app-deployment</code> : 删除命名空间<code>ipo-platform</code>下的名称为<code>eureka-app-deployment</code>的<code>deployment</code></p>
</li>
<li><p><code>kubectl rollout restart deploy eureka-app-deployment -n ipo-platform</code> : 重启命名空间<code>ipo-platform</code>下的名称为<code>eureka-app-deployment</code>的<code>deployment</code></p>
</li>
<li><p><code>kubectl delete -n ipo-platform configmap common-config</code> : 删除<code>configmap</code></p>
</li>
</ul>
<h1 id="03-问题解决"><a href="#03-问题解决" class="headerlink" title="03.问题解决"></a>03.问题解决</h1><ul>
<li>问题01: 执行<code>kubeadm init --config=init-config.yaml</code>如下报错终止:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[api-check] The API server is not healthy after 4m0.001007368s</span><br><span class="line"></span><br><span class="line">Unfortunately, an error has occurred:</span><br><span class="line">	context deadline exceeded</span><br><span class="line"></span><br><span class="line">This error is likely caused by:</span><br><span class="line">	- The kubelet is not running</span><br><span class="line">	- The kubelet is unhealthy due to a misconfiguration of the node <span class="keyword">in</span> some way (required cgroups disabled)</span><br><span class="line"></span><br><span class="line">If you are on a systemd-powered system, you can try to troubleshoot the error with the following commands:</span><br><span class="line">	- <span class="string">&#x27;systemctl status kubelet&#x27;</span></span><br><span class="line">	- <span class="string">&#x27;journalctl -xeu kubelet&#x27;</span></span><br><span class="line"></span><br><span class="line">Additionally, a control plane component may have crashed or exited when started by the container runtime.</span><br><span class="line">To troubleshoot, list all containers using your preferred container runtimes CLI.</span><br><span class="line">Here is one example how you may list all running Kubernetes containers by using crictl:</span><br><span class="line">	- <span class="string">&#x27;crictl --runtime-endpoint unix:///var/run/containerd/containerd.sock ps -a | grep kube | grep -v pause&#x27;</span></span><br><span class="line">	Once you have found the failing container, you can inspect its logs with:</span><br><span class="line">	- <span class="string">&#x27;crictl --runtime-endpoint unix:///var/run/containerd/containerd.sock logs CONTAINERID&#x27;</span></span><br><span class="line">error execution phase wait-control-plane: could not initialize a Kubernetes cluster</span><br><span class="line">To see the stack trace of this error execute with --v=5 or higher</span><br></pre></td></tr></table></figure></li>
</ul>
<p>使用命令 <code>journalctl -fu containerd</code> 发现启动容器重新去获取了<code>pause:3.6</code>版本，因为网络原因导致拉取失败，报错如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">11月 05 22:05:38 k8s-master containerd[1627]: time=&quot;2024-11-05T22:05:38.975911133+08:00&quot; level=error msg=&quot;RunPodSandbox for &amp;PodSandboxMetadata&#123;Name:kube-scheduler-k8s-master,Uid:5c8922b1a239f8c82c853b76323d525f,Namespace:kube-system,Attempt:0,&#125; failed, error&quot; error=&quot;rpc error: code = DeadlineExceeded desc = failed to get sandbox image \&quot;registry.k8s.io/pause:3.6\&quot;: failed to pull image \&quot;registry.k8s.io/pause:3.6\&quot;: failed to pull and unpack image \&quot;registry.k8s.io/pause:3.6\&quot;: failed to resolve reference \&quot;registry.k8s.io/pause:3.6\&quot;: failed to do request: Head \&quot;https://us-west2-docker.pkg.dev/v2/k8s-artifacts-prod/images/pause/manifests/3.6\&quot;: dial tcp 173.194.202.82:443: i/o timeout&quot;</span><br><span class="line">11月 05 22:05:38 k8s-master containerd[1627]: time=&quot;2024-11-05T22:05:38.990153560+08:00&quot; level=info msg=&quot;trying next host&quot; error=&quot;failed to do request: Head \&quot;https://us-west2-docker.pkg.dev/v2/k8s-artifacts-prod/images/pause/manifests/3.6\&quot;: dial tcp 173.194.202.82:443: i/o timeout&quot; host=registry.k8s.io</span><br></pre></td></tr></table></figure>

<p>是因为拉取的 <code>docker image</code> 版本有问题， 最开始执行 <code>docker image ls</code> 发现显示如下, 其中有个 <code>pause</code> 版本为 <code>3.9</code>， 发现从阿里云直接获取不到<code>3.6</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver            v1.30.6    a247bfa6152e   13 days ago    117MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager   v1.30.6    382949f9bfdd   13 days ago    111MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler            v1.30.6    ad5858afd532   13 days ago    62MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy                v1.30.6    2cce8902ed3c   13 days ago    84.7MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/coredns                   v1.11.3    c69fa2e9cbf5   3 months ago   61.8MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/etcd                      3.5.15-0   2e96e5913fc0   3 months ago   148MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/pause                     3.9        e6f181688397   2 years ago    744kB</span><br></pre></td></tr></table></figure>

<p>下载 <code>3,6</code> 用了如下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ctr -n k8s.io i pull registry.aliyuncs.com/google_containers/pause:3.6</span><br><span class="line">ctr -n k8s.io i tag registry.aliyuncs.com/google_containers/pause:3.6 registry.k8s.io/pause:3.6</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6</span><br></pre></td></tr></table></figure>
<p>之后 <code>docker image ls</code>显示如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver            v1.30.6    a247bfa6152e   13 days ago    117MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager   v1.30.6    382949f9bfdd   13 days ago    111MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler            v1.30.6    ad5858afd532   13 days ago    62MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy                v1.30.6    2cce8902ed3c   13 days ago    84.7MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/coredns                   v1.11.3    c69fa2e9cbf5   3 months ago   61.8MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/etcd                      3.5.15-0   2e96e5913fc0   3 months ago   148MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/pause                     3.9        e6f181688397   2 years ago    744kB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/pause                     3.6        6270bb605e12   3 years ago    683kB</span><br></pre></td></tr></table></figure>

<ul>
<li>问题02：执行命令 <code>sudo kubeadm join --config=join-config.yaml</code> 报如下错误:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ERROR CRI]: container runtime is not running: output: </span><br><span class="line">time=<span class="string">&quot;2024-11-06T10:17:25+08:00&quot;</span> level=fatal msg=<span class="string">&quot;validate service connection: validate CRI v1 runtime API for endpoint \&quot;unix:///var/run/containerd/containerd.sock\&quot;:</span></span><br><span class="line"><span class="string"> rpc error: code = Unimplemented desc = unknown service runtime.v1.RuntimeService&quot;</span></span><br><span class="line">, error: <span class="built_in">exit</span> status 1</span><br></pre></td></tr></table></figure>

<p>解决方案是修改文件 <code>/etc/containerd/config.toml</code> , 修改内容如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注释如下行</span></span><br><span class="line">disabled_plugins = [<span class="string">&quot;cri&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启containerd</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl restart containerd</span><br></pre></td></tr></table></figure>

<ul>
<li>参考链接: <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubeadm/issues/2851">https://github.com/kubernetes/kubeadm/issues/2851</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chengfengjie718.github.io/java/k8s.html" data-id="cm35ak0gq0006fhzm6vjmc1as" data-title="K8s学习笔记" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/01/10/java-archives/">Java</a>
          </li>
        
          <li>
            <a href="/2018/10/24/other-archives/">杂学</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 chengfengjie718<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>